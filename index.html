<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Inheritance Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals with Slate Blue Accent -->
    <!-- Application Structure Plan: A multi-step wizard SPA. This structure was chosen because the source report emphasizes a strict, sequential process for calculation (`Ilm al-Fara'id`). Breaking the complex task into logical chunks (Setup -> Finances -> Heirs -> Results) reduces user cognitive load, prevents errors, and creates a guided, trustworthy experience, which is crucial for a sensitive financial and religious topic. The user flow directly mirrors the legal steps: pre-distribution deductions first, then heir identification, and finally calculation and explanation. This is the most usable design for this specific content. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Gross Estate, Deductions. Goal: Calculate Net Estate. Viz: Live-updating summary text. Interaction: Number input with a slider. Justification: Provides both precision and tactile feedback. Library: Vanilla JS.
        - Report Info: Surviving relatives. Goal: Identify potential heirs. Viz: Grouped list with steppers. Interaction: +/â€“ buttons. Justification: Minimizes typing errors on mobile. Library: Vanilla JS.
        - Report Info: Heir shares. Goal: Show distribution proportions. Viz: Donut Chart. Interaction: Hover tooltips. Justification: Gives an immediate, intuitive overview of the final distribution. Library: Chart.js (Canvas).
        - Report Info: Calculation rules (`Hajb`, `Awl`, `Radd`). Goal: Explain the 'why' behind each result. Viz: Detailed table with an accordion-style explanation for each heir. Interaction: Click to expand/collapse. Justification: Builds trust and provides critical educational value without cluttering the UI. Library: Vanilla JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step-card, .tab-panel {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            will-change: transform, opacity;
        }
        .hidden-item { display: none; }
        .radio-card {
            transition: all 0.2s ease-in-out;
        }
        .radio-card.selected {
            transform: translateY(-2px);
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .stepper-btn {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 500;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            height: auto;
            max-height: 450px;
        }
        .accordion-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .accordion-content.collapsed {
             max-height: 0;
        }
        .tab {
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Islamic Inheritance Calculator</h1>
            <p class="mt-2 text-slate-600">A tool to calculate the distribution of an estate according to Islamic law.</p>
        </header>

        <div class="border-b border-slate-200 mb-8">
            <nav class="flex -mb-px justify-center" aria-label="Tabs">
                <a onclick="switchTab('full')" id="tab-full" class="tab active">Full Calculation</a>
                <a onclick="switchTab('simple')" id="tab-simple" class="tab">Quick Share Calculator</a>
            </nav>
        </div>

        <main>
            <!-- Full Calculator Panel -->
            <div id="panel-full" class="tab-panel">
                <div id="progress-bar" class="w-full bg-slate-200 rounded-full h-2.5 mb-8">
                    <div id="progress-indicator" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%; transition: width 0.3s ease-in-out;"></div>
                </div>

                <!-- Step 1: Foundational Information -->
                <div id="step-1" class="step-card">
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-1">Step 1: Foundational Information</h2>
                        <p class="text-slate-600 mb-6">Let's start with the basics. This information is crucial for the calculation.</p>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-lg font-medium text-slate-700 mb-2">Who is the deceased? <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-2 gap-4">
                                    <label onclick="selectRadioCard(this)" class="radio-card p-4 border rounded-lg cursor-pointer text-center">
                                        <input type="radio" name="deceasedGender" value="Male" class="sr-only">
                                        <span class="text-4xl">ðŸ‘¨</span>
                                        <span class="block mt-2 font-semibold">Male</span>
                                    </label>
                                    <label onclick="selectRadioCard(this)" class="radio-card p-4 border rounded-lg cursor-pointer text-center">
                                        <input type="radio" name="deceasedGender" value="Female" class="sr-only">
                                        <span class="text-4xl">ðŸ‘©</span>
                                        <span class="block mt-2 font-semibold">Female</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-lg font-medium text-slate-700 mb-2">Which school of law to use? <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <label onclick="selectRadioCard(this)" class="radio-card p-4 border rounded-lg cursor-pointer text-center selected">
                                        <input type="radio" name="madhhab" value="Sunni" class="sr-only" checked>
                                        <span class="block font-semibold">Sunni</span>
                                        <span class="text-xs text-slate-500">(Hanafi, Shafi'i, Maliki, Hanbali)</span>
                                    </label>
                                    <label onclick="selectRadioCard(this)" class="radio-card p-4 border rounded-lg cursor-pointer text-center">
                                        <input type="radio" name="madhhab" value="Shia" class="sr-only">
                                        <span class="block font-semibold">Shi'a (Ja'fari)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 text-right"><button onclick="nextStep()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Next: Estate Finances &rarr;</button></div>
                    </div>
                </div>

                <!-- Step 2: Net Estate Calculation -->
                <div id="step-2" class="step-card hidden-item">
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-1">Step 2: Calculate the Net Estate</h2>
                        <p class="text-slate-600 mb-6">Before distribution, all debts and valid bequests must be settled.</p>
                        <div class="space-y-6">
                            <div>
                                <label for="grossEstate" class="block text-lg font-medium text-slate-700">Total Value of the Estate <span class="text-red-500">*</span></label>
                                <div class="mt-2 flex items-center gap-4">
                                    <input type="number" id="grossEstate" class="w-full p-3 border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="e.g., 100000" oninput="updateEstateSlider()">
                                </div>
                                <input type="range" id="estateSlider" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer mt-3" min="0" max="10000000" step="100000" oninput="updateEstateInput()">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div><label for="funeralCosts" class="block font-medium text-slate-700">Funeral & Burial Costs</label><input type="number" id="funeralCosts" class="mt-1 block w-full p-3 border-slate-300 rounded-md shadow-sm" placeholder="0"></div>
                                <div><label for="totalDebts" class="block font-medium text-slate-700">Total Outstanding Debts</label><input type="number" id="totalDebts" class="mt-1 block w-full p-3 border-slate-300 rounded-md shadow-sm" placeholder="0"></div>
                                <div><label for="bequest" class="block font-medium text-slate-700">Bequest (Wasiyyah)</label><input type="number" id="bequest" class="mt-1 block w-full p-3 border-slate-300 rounded-md shadow-sm" placeholder="0"><p id="bequestWarning" class="text-xs text-red-500 mt-1 hidden-item"></p></div>
                            </div>
                        </div>
                        <div class="mt-8 bg-slate-100 p-4 rounded-lg text-center">
                            <p class="text-slate-600">Net Distributable Estate:</p>
                            <p id="netEstateDisplay" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="mt-8 flex justify-between">
                            <button onclick="prevStep()" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 transition-colors">&larr; Back</button>
                            <button onclick="nextStep()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Next: Identify Heirs &rarr;</button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Identify Surviving Heirs -->
                <div id="step-3" class="step-card hidden-item">
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-1">Step 3: Identify Surviving Heirs</h2>
                        <p class="text-slate-600 mb-6">Enter the number of each surviving relative. Leave as 0 if none.</p>
                        <div id="heirs-list" class="space-y-8"></div>
                        <div class="mt-8 flex justify-between">
                            <button onclick="prevStep()" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 transition-colors">&larr; Back</button>
                            <button onclick="calculateAndShowResults()" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors text-lg">Calculate Inheritance</button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Results -->
                <div id="step-4" class="step-card hidden-item">
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-1 text-center">Inheritance Distribution Results</h2>
                        <p class="text-slate-600 mb-6 text-center">Based on the information provided and the selected school of law.</p>
                        <div id="special-case-notification" class="hidden-item p-4 mb-6 rounded-lg"></div>
                        <div class="chart-container mb-8"><canvas id="resultsChart"></canvas></div>
                        <div id="results-table-container"></div>
                        <div class="mt-8 flex justify-between items-center">
                            <button onclick="startOver()" class="bg-slate-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 transition-colors">Start Over</button>
                            <button onclick="window.print()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Print Results</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simple Calculator Panel -->
            <div id="panel-simple" class="tab-panel hidden-item">
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-1">Quick Share Calculator</h2>
                    <p class="text-slate-600 mb-6">Quickly find the percentage share for each heir without entering financial details.</p>
                    <div class="space-y-6">
                        <div>
                                <label class="block text-lg font-medium text-slate-700 mb-2">Who is the deceased? <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-2 gap-4">
                                    <label onclick="selectRadioCard(this, 'simple')" class="radio-card p-4 border rounded-lg cursor-pointer text-center"><input type="radio" name="deceasedGenderSimple" value="Male" class="sr-only"><span class="text-4xl">ðŸ‘¨</span><span class="block mt-2 font-semibold">Male</span></label>
                                    <label onclick="selectRadioCard(this, 'simple')" class="radio-card p-4 border rounded-lg cursor-pointer text-center"><input type="radio" name="deceasedGenderSimple" value="Female" class="sr-only"><span class="text-4xl">ðŸ‘©</span><span class="block mt-2 font-semibold">Female</span></label>
                                </div>
                            </div>
                         <div>
                            <label class="block text-lg font-medium text-slate-700 mb-2">Which school of law to use? <span class="text-red-500">*</span></label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <label onclick="selectRadioCard(this, 'simple')" class="radio-card p-4 border rounded-lg cursor-pointer text-center selected">
                                    <input type="radio" name="madhhabSimple" value="Sunni" class="sr-only" checked>
                                    <span class="block font-semibold">Sunni</span>
                                </label>
                                <label onclick="selectRadioCard(this, 'simple')" class="radio-card p-4 border rounded-lg cursor-pointer text-center">
                                    <input type="radio" name="madhhabSimple" value="Shia" class="sr-only">
                                    <span class="block font-semibold">Shi'a (Ja'fari)</span>
                                </label>
                            </div>
                        </div>
                        <div id="heirs-list-simple" class="space-y-8"></div>
                    </div>
                    <div class="mt-8 text-center">
                        <button onclick="calculateSimpleShares()" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors text-lg">Calculate Shares</button>
                    </div>
                    <div id="simple-results-container" class="mt-8 hidden-item"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const state = {
            currentStep: 1,
            deceasedGender: null,
            madhhab: 'Sunni',
            grossEstate: 0,
            funeralCosts: 0,
            totalDebts: 0,
            bequest: 0,
            netEstate: 0,
            heirs: {},
        };

        const simpleState = {
            deceasedGender: null,
            madhhab: 'Sunni',
            heirs: {},
        };

        const heirDefinitions = [
            { group: 'Spouse', heirs: [ { id: 'husband', name: 'Husband', max: 1, condition: (gender) => gender === 'Female' }, { id: 'wives', name: 'Wife/Wives', max: 4, condition: (gender) => gender === 'Male' }] },
            { group: 'Descendants', heirs: [ { id: 'sons', name: 'Sons', max: 50 }, { id: 'daughters', name: 'Daughters', max: 50 }, { id: 'son_sons', name: 'Son\'s Sons', max: 50, tooltip: "Sons of the son (agnatic)." }, { id: 'son_daughters', name: 'Son\'s Daughters', max: 50, tooltip: "Daughters of the son (agnatic)." }] },
            { group: 'Ascendants', heirs: [ { id: 'father', name: 'Father', max: 1 }, { id: 'mother', name: 'Mother', max: 1 }, { id: 'paternal_grandfather', name: 'Paternal Grandfather', max: 1, tooltip: "Father's father." }, { id: 'paternal_grandmother', name: 'Paternal Grandmother', max: 1, tooltip: "Father's mother." }, { id: 'maternal_grandmother', name: 'Maternal Grandmother', max: 1, tooltip: "Mother's mother." }] },
            { group: 'Siblings & their Descendants', heirs: [ { id: 'full_brothers', name: 'Full Brothers', max: 50, tooltip: "Share same father and mother." }, { id: 'full_sisters', name: 'Full Sisters', max: 50, tooltip: "Share same father and mother." }, { id: 'paternal_brothers', name: 'Paternal Brothers', max: 50, tooltip: "Share same father, different mother." }, { id: 'paternal_sisters', name: 'Paternal Sisters', max: 50, tooltip: "Share same father, different mother." }, { id: 'maternal_siblings', name: 'Maternal Siblings', max: 50, tooltip: "Share same mother, different father." }] },
        ];

        let resultsChart = null;
        
        function initializeHeirs(containerId, stateObj, gender) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            stateObj.heirs = {};

            heirDefinitions.forEach(group => {
                const visibleHeirs = group.heirs.filter(heir => !heir.condition || heir.condition(gender));
                if(visibleHeirs.length > 0) {
                    const groupDiv = document.createElement('div');
                    groupDiv.innerHTML = `<h3 class="text-xl font-semibold text-slate-800 border-b pb-2 mb-4">${group.group}</h3>`;
                    const listDiv = document.createElement('div');
                    listDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4';
                    
                    visibleHeirs.forEach(heir => {
                        stateObj.heirs[heir.id] = 0;
                        const suffix = containerId.includes('simple') ? 'Simple' : '';
                        const heirId = `${heir.id}${suffix}`;

                        const wrapper = document.createElement('div');
                        wrapper.className = 'flex items-center justify-between';
                        
                        let labelHTML = `<label for="${heirId}" class="text-lg text-slate-700">${heir.name}`;
                        if (heir.tooltip) {
                            labelHTML += ` <div class="tooltip inline-block ml-1"><span class="text-blue-500 cursor-pointer">&#9432;</span><span class="tooltiptext">${heir.tooltip}</span></div>`;
                        }
                        labelHTML += `</label>`;

                        const stepperHTML = `
                            <div class="flex items-center gap-2">
                                <button class="stepper-btn bg-slate-200 rounded-md text-slate-600 hover:bg-slate-300 transition-colors" onclick="updateHeirCount('${heir.id}', -1, ${heir.max}, '${suffix}')">-</button>
                                <input type="number" id="${heirId}" class="w-16 text-center text-lg font-medium p-2 border-slate-300 rounded-md shadow-sm" value="0" min="0" max="${heir.max}" onchange="updateHeirState('${heir.id}', this.value, ${heir.max}, '${suffix}')">
                                <button class="stepper-btn bg-slate-200 rounded-md text-slate-600 hover:bg-slate-300 transition-colors" onclick="updateHeirCount('${heir.id}', 1, ${heir.max}, '${suffix}')">+</button>
                            </div>`;
                        
                        wrapper.innerHTML = labelHTML + stepperHTML;
                        listDiv.appendChild(wrapper);
                    });
                    groupDiv.appendChild(listDiv);
                    container.appendChild(groupDiv);
                }
            });
        }
        
        function updateHeirCount(id, change, max, suffix = '') {
            const input = document.getElementById(id + suffix);
            let currentValue = parseInt(input.value);
            let newValue = currentValue + change;
            if (newValue < 0) newValue = 0;
            if (newValue > max) newValue = max;
            input.value = newValue;
            updateHeirState(id, newValue, max, suffix);
        }

        function updateHeirState(id, value, max, suffix = '') {
            const stateObj = suffix === 'Simple' ? simpleState : state;
            let numValue = parseInt(value);
            if (isNaN(numValue) || numValue < 0) numValue = 0;
            if (numValue > max) numValue = max;
            document.getElementById(id + suffix).value = numValue;
            stateObj.heirs[id] = numValue;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden-item'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`panel-${tabName}`).classList.remove('hidden-item');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function updateProgress() {
            // Total steps are now 4: Info, Finances, Heirs, Results
            const totalSteps = 4;
            document.getElementById('progress-indicator').style.width = `${((state.currentStep - 1) / (totalSteps -1)) * 100}%`;
        }

        function nextStep() {
            if (validateStep(state.currentStep)) {
                if (state.currentStep < 3) { // Flow from step 1 to 2, and 2 to 3
                    document.getElementById(`step-${state.currentStep}`).classList.add('hidden-item');
                    state.currentStep++;
                    document.getElementById(`step-${state.currentStep}`).classList.remove('hidden-item');
                    updateProgress();
                    window.scrollTo(0, 0);
                }
            }
        }

        function prevStep() {
            if (state.currentStep > 1) {
                document.getElementById(`step-${state.currentStep}`).classList.add('hidden-item');
                state.currentStep--;
                document.getElementById(`step-${state.currentStep}`).classList.remove('hidden-item');
                updateProgress();
                window.scrollTo(0, 0);
            }
        }
        
        function validateStep(step) {
            if(step === 1) {
                const gender = document.querySelector('input[name="deceasedGender"]:checked');
                if (!gender) { alert('Please select the gender of the deceased.'); return false; }
                state.deceasedGender = gender.value;
                state.madhhab = document.querySelector('input[name="madhhab"]:checked').value;
                initializeHeirs('heirs-list', state, state.deceasedGender);
            }
            if(step === 2) {
                calculateNetEstate(); 
                if (state.grossEstate <= 0) { alert('Please enter a valid total estate value.'); return false; }
                if (state.netEstate < 0) { alert('Deductions cannot be greater than the total estate value.'); return false; }
            }
            return true;
        }

        function calculateNetEstate() {
            state.grossEstate = parseFloat(document.getElementById('grossEstate').value) || 0;
            state.funeralCosts = parseFloat(document.getElementById('funeralCosts').value) || 0;
            state.totalDebts = parseFloat(document.getElementById('totalDebts').value) || 0;
            const estateAfterCosts = state.grossEstate - state.funeralCosts - state.totalDebts;
            const maxBequest = estateAfterCosts > 0 ? estateAfterCosts / 3 : 0;
            state.bequest = parseFloat(document.getElementById('bequest').value) || 0;
            const bequestWarning = document.getElementById('bequestWarning');
            if(state.bequest > maxBequest) {
                bequestWarning.textContent = `Bequest cannot exceed 1/3 of estate. Max: ${maxBequest.toFixed(2)}`;
                bequestWarning.classList.remove('hidden-item');
                state.bequest = maxBequest;
            } else {
                bequestWarning.classList.add('hidden-item');
            }
            state.netEstate = estateAfterCosts - state.bequest;
            document.getElementById('netEstateDisplay').textContent = `${state.netEstate.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        
        function calculateAndShowResults() {
            const results = calculateInheritance(state);
            displayResults(results);
            // Transition to results step
            document.getElementById(`step-${state.currentStep}`).classList.add('hidden-item');
            state.currentStep = 4; // Results are the 4th step now
            document.getElementById(`step-${state.currentStep}`).classList.remove('hidden-item');
            updateProgress();
            window.scrollTo(0, 0);
        }
        
        function displayResults(results) {
            const { distribution, specialCase, netEstate } = results;
            const notificationDiv = document.getElementById('special-case-notification');
            if (specialCase) {
                notificationDiv.innerHTML = `<h4 class="font-bold">${specialCase.name}</h4><p>${specialCase.explanation}</p>`;
                notificationDiv.className = 'p-4 mb-6 rounded-lg bg-blue-100 border-l-4 border-blue-500 text-blue-800';
                notificationDiv.classList.remove('hidden-item');
            } else {
                notificationDiv.classList.add('hidden-item');
            }
            const tableContainer = document.getElementById('results-table-container');
            let tableHTML = `<table class="w-full text-left border-collapse">
                <thead><tr class="bg-slate-100"><th class="p-3 text-sm font-semibold tracking-wide">Heir</th><th class="p-3 text-sm font-semibold tracking-wide text-center">Share</th><th class="p-3 text-sm font-semibold tracking-wide text-right">Amount</th><th class="p-3 text-sm font-semibold tracking-wide text-center"></th></tr></thead><tbody>`;
            const chartLabels = [], chartData = [], chartColors = ['#3b82f6', '#16a34a', '#f97316', '#8b5cf6', '#ec4899', '#facc15', '#10b981', '#64748b', '#ef4444', '#06b6d4'];
            let colorIndex = 0;
            
            distribution.forEach((heir) => {
                const individualPercentage = heir.percentage / heir.count;
                const individualAmount = heir.amount / heir.count;

                for (let i = 0; i < heir.count; i++) {
                     const heirName = heir.count > 1 ? `${heir.name} ${i + 1}` : heir.name;
                     tableHTML += `<tr class="border-b border-slate-200">
                        <td class="p-3 font-medium">${heirName}</td>
                        <td class="p-3 text-center">${individualPercentage.toFixed(2)}%</td>
                        <td class="p-3 text-right font-semibold">${individualAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="p-3 text-center"><button onclick="toggleAccordion(this)" class="text-blue-600 hover:underline text-sm">Hide</button></td>
                     </tr>
                     <tr><td colspan="4" class="p-0"><div class="accordion-content bg-slate-50"><p class="p-4 text-sm text-slate-700">${heir.explanation}</p></div></td></tr>`;
                    
                    if(individualAmount > 0) {
                        chartLabels.push(heirName);
                        chartData.push(individualAmount);
                        colorIndex = (colorIndex + 1) % chartColors.length;
                    }
                }
            });
            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
            const ctx = document.getElementById('resultsChart').getContext('2d');
            if (resultsChart) resultsChart.destroy();
            resultsChart = new Chart(ctx, { type: 'doughnut', data: { labels: chartLabels, datasets: [{ data: chartData, backgroundColor: chartColors, borderColor: '#ffffff', borderWidth: 2, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20 } }, tooltip: { callbacks: { label: (c) => c.label ? `${c.label}: ${c.parsed.toLocaleString()} (${(c.parsed/netEstate*100).toFixed(2)}%)` : '' } } } } });
        }
        
        function toggleAccordion(button) {
            const content = button.closest('tr').nextElementSibling.querySelector('.accordion-content');
            content.classList.toggle('collapsed');
            button.textContent = content.classList.contains('collapsed') ? "Explain" : "Hide";
        }

        function startOver() {
            state.currentStep = 1; state.heirs = {};
            document.querySelectorAll('.step-card').forEach((el, i) => el.classList.toggle('hidden-item', i !== 0));
            document.getElementById('grossEstate').value = ''; document.getElementById('funeralCosts').value = ''; document.getElementById('totalDebts').value = ''; document.getElementById('bequest').value = '';
            switchTab('full');
            updateProgress();
            window.scrollTo(0, 0);
        }

        function selectRadioCard(labelElement, suffix = '') {
            const radio = labelElement.querySelector('input');
            const radioName = radio.name;
            document.querySelectorAll(`input[name="${radioName}"]`).forEach(r => r.parentElement.classList.remove('selected'));
            labelElement.classList.add('selected');
            radio.checked = true;

            const stateObj = suffix === 'simple' ? simpleState : state;
            if (radioName.includes('Gender')) {
                stateObj.deceasedGender = radio.value;
                const containerId = suffix ? 'heirs-list-simple' : 'heirs-list';
                initializeHeirs(containerId, stateObj, stateObj.deceasedGender);
            } else if (radioName.includes('madhhab')) {
                 stateObj.madhhab = radio.value;
            }
        }
        
        function calculateSimpleShares() {
            const gender = document.querySelector('input[name="deceasedGenderSimple"]:checked');
            if (!gender) {
                alert('Please select the gender of the deceased.');
                return;
            }
            simpleState.deceasedGender = gender.value;
            simpleState.madhhab = document.querySelector('input[name="madhhabSimple"]:checked').value;
            const tempState = { ...simpleState, netEstate: 1000000 }; // Use dummy estate for percentage calc
            const results = calculateInheritance(tempState);
            displaySimpleResults(results);
        }
        
        function displaySimpleResults(results) {
            const { distribution, specialCase } = results;
            const container = document.getElementById('simple-results-container');
            
            let specialCaseHTML = '';
            if (specialCase) {
                specialCaseHTML = `<div class="p-4 mb-6 rounded-lg bg-blue-100 border-l-4 border-blue-500 text-blue-800">
                    <h4 class="font-bold">${specialCase.name}</h4><p>${specialCase.explanation}</p>
                </div>`;
            }

            let tableHTML = `<h3 class="text-xl font-semibold text-slate-800 border-b pb-2 my-4">Distribution Results</h3><table class="w-full text-left border-collapse">
                <thead><tr class="bg-slate-100"><th class="p-3 text-sm font-semibold tracking-wide">Heir</th><th class="p-3 text-sm font-semibold tracking-wide text-right">Percentage</th><th class="p-3 text-sm font-semibold tracking-wide text-center"></th></tr></thead><tbody>`;
            
            let totalPercentage = 0;
            distribution.forEach(heir => {
                 const individualPercentage = heir.percentage / heir.count;
                 for (let i = 0; i < heir.count; i++) {
                    const heirName = heir.count > 1 ? `${heir.name} ${i + 1}` : heir.name;
                    tableHTML += `<tr class="border-b border-slate-200">
                        <td class="p-3 font-medium">${heirName}</td>
                        <td class="p-3 text-right font-semibold">${individualPercentage.toFixed(2)}%</td>
                        <td class="p-3 text-center"><button onclick="toggleAccordion(this)" class="text-blue-600 hover:underline text-sm">Hide</button></td>
                    </tr>
                    <tr><td colspan="3" class="p-0"><div class="accordion-content bg-slate-50"><p class="p-4 text-sm text-slate-700">${heir.explanation}</p></div></td></tr>`;
                    totalPercentage += individualPercentage;
                }
            });

            tableHTML += `<tr class="bg-slate-100 font-bold"><td class="p-3">Total</td><td class="p-3 text-right">${totalPercentage.toFixed(2)}%</td><td></td></tr>`
            tableHTML += `</tbody></table>`;
            container.innerHTML = specialCaseHTML + tableHTML;
            container.classList.remove('hidden-item');
        }

        function updateEstateSlider() {
            document.getElementById('estateSlider').value = document.getElementById('grossEstate').value;
            calculateNetEstate();
        }
        function updateEstateInput() {
            document.getElementById('grossEstate').value = document.getElementById('estateSlider').value;
            calculateNetEstate();
        }

        document.querySelectorAll('input[type=number]').forEach(input => input.addEventListener('input', calculateNetEstate));
        
        // --- Core Calculation Engine ---
        function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
        function lcm(a, b) { return (a * b) / gcd(a, b); }

        function calculateInheritance(s) {
            const h = s.heirs;
            let heirs = {};
            let explanations = {};
            let specialCase = null;
            
            Object.keys(h).forEach(k => {
                if (h[k] > 0) heirs[k] = { id: k, count: h[k], name: heirDefinitions.flatMap(g => g.heirs).find(heir => heir.id === k).name };
            });

            const has = (key) => heirs[key] && !heirs[key].isExcluded;
            const exclude = (heirId, reason) => { if(has(heirId)) { heirs[heirId].isExcluded = true; explanations[heirId] = reason; }};
            
            if (s.madhhab === 'Shia') {
                const class1 = ['sons', 'daughters', 'father', 'mother'];
                const class2 = ['son_sons', 'son_daughters', 'full_brothers', 'full_sisters', 'paternal_brothers', 'paternal_sisters', 'maternal_siblings', 'paternal_grandfather', 'paternal_grandmother', 'maternal_grandmother'];
                if (class1.some(has)) class2.forEach(id => exclude(id, `Excluded by a Class 1 heir (Parent or Child) under Shi'a law.`));
            } else { // Sunni Agnatic exclusion
                if (has('sons')) { ['son_sons', 'son_daughters', 'full_brothers', 'full_sisters', 'paternal_brothers', 'paternal_sisters', 'maternal_siblings'].forEach(id => exclude(id, `Excluded by Son (Hajb Hirman).`));}
                if (has('father')) { ['paternal_grandfather', 'paternal_grandmother', 'full_brothers', 'full_sisters', 'paternal_brothers', 'paternal_sisters', 'maternal_siblings'].forEach(id => exclude(id, `Excluded by Father (Hajb Hirman).`)); }
                if (has('mother')) { ['maternal_grandmother', 'paternal_grandmother'].forEach(id => exclude(id, `Excluded by Mother (Hajb Hirman).`)); }
                if (has('son_sons')) {['full_brothers', 'full_sisters', 'paternal_brothers', 'paternal_sisters', 'maternal_siblings'].forEach(id => exclude(id, `Excluded by Son's Son (Hajb Hirman).`));}
                if (has('paternal_grandfather')) { ['maternal_siblings'].forEach(id => exclude(id, `Excluded by Paternal Grandfather (Hajb Hirman).`)); }
                if (has('daughters') || has('son_daughters')) { ['maternal_siblings'].forEach(id => exclude(id, 'Excluded by a female descendant (daughter or son\'s daughter).')); }
                if (has('full_brothers')) { ['paternal_brothers', 'paternal_sisters'].forEach(id => exclude(id, `Excluded by Full Brother (Hajb Hirman).`)); }
                if (has('full_sisters') && h['full_sisters'] >= 2 && !has('full_brothers') && !(has('daughters') || has('son_daughters'))) { exclude('paternal_sisters', 'Excluded as Full Sisters exhaust the 2/3 share for sisters.');}
            }
            
            let sharers = {};
            const hasSon = has('sons');
            const hasMaleDesc = hasSon || has('son_sons');
            const hasDescendant = hasMaleDesc || has('daughters') || has('son_daughters');
            const multipleSiblings = ['full_brothers', 'full_sisters', 'paternal_brothers', 'paternal_sisters', 'maternal_siblings'].reduce((acc, id) => acc + (has(id) ? h[id] : 0), 0) >= 2;
            
            if (has('husband')) sharers.husband = { n:1, d: hasDescendant ? 4:2, r: `Receives ${hasDescendant ? '1/4' : '1/2'} due to the ${hasDescendant ? 'presence' : 'absence'} of descendants.`};
            if (has('wives')) sharers.wives = { n:1, d: hasDescendant ? 8:4, r: `Receives ${hasDescendant ? '1/8' : '1/4'} due to the ${hasDescendant ? 'presence' : 'absence'} of descendants.`};
            if (has('mother')) { if (hasDescendant || multipleSiblings) sharers.mother = {n:1,d:6, r:'Receives 1/6 due to the presence of descendants or multiple siblings.'}; else if(has('father') && (has('husband') || has('wives')) && s.madhhab==='Sunni') {sharers.mother={type:'1/3 of Residue'}; explanations.mother = 'Special case (`Umariyyatayn`): Receives 1/3 of the residue after the spouse\'s share.'} else sharers.mother={n:1,d:3, r:'Receives 1/3 as there are no descendants or multiple siblings.'};}
            if (has('father') && hasDescendant) sharers.father = { n:1, d:6, r: 'Receives 1/6 as a Sharer due to the presence of descendants.'};
            if (has('daughters') && !hasSon) sharers.daughters = {n: h.daughters>1?2:1, d: h.daughters>1?3:2, r:`Receives a fixed share of ${h.daughters>1?'2/3':'1/2'} as there is no Son.`};
            if (has('son_daughters') && !hasMaleDesc) { if (!has('daughters')) sharers.son_daughters = {n:h.son_daughters>1?2:1, d:h.son_daughters>1?3:2, r:`Receives a fixed share of ${h.son_daughters>1?'2/3':'1/2'} as primary female descendants.`}; else if(h.daughters===1) sharers.son_daughters = {n:1,d:6, r:'Receives 1/6 to complete the 2/3 total share for female descendants.'};}
            if (has('full_sisters') && !hasMaleDesc && !has('father') && !(has('daughters') || has('son_daughters'))) { sharers.full_sisters = { n:h.full_sisters>1?2:1,d:h.full_sisters>1?3:2,r:`Receives a fixed share of ${h.full_sisters>1?'2/3':'1/2'}.`};}
            if (has('maternal_siblings') && !hasDescendant && !has('father') && !has('paternal_grandfather')) sharers.maternal_siblings = { n:h.maternal_siblings>1?1:1,d:h.maternal_siblings>1?3:6,r:`Receives a collective share of ${h.maternal_siblings>1?'1/3':'1/6'}.`};
            Object.keys(sharers).forEach(id => explanations[id] = sharers[id].r);

            let asaba = null;
            if (s.madhhab === 'Sunni') {
                const asabaMap = [ {m:'sons',f:'daughters',p:2}, {m:'son_sons',f:'son_daughters',p:2}, {m:'full_brothers',f:'full_sisters',p:2}, {m:'paternal_brothers',f:'paternal_sisters',p:2}, {m:'father',f:null,p:1}, {m:'paternal_grandfather',f:null,p:1} ];
                for (const group of asabaMap) {
                    if (has(group.m) && !sharers[group.m]) { asaba={...group}; break;}
                }
                if (!asaba && has('full_sisters') && (has('daughters') || has('son_daughters'))) asaba = {m:'full_sisters',f:null, p:1, r:'Becomes a Residuary (`Asabah`) with female descendants.'};
            }

            let commonD = 1;
            Object.values(sharers).forEach(s=> {if(s.n) commonD=lcm(commonD,s.d)});
            
            let assignedShares = {};
            Object.keys(sharers).forEach(id => {
                const sh = sharers[id];
                if(sh.n) assignedShares[id] = {n:sh.n * (commonD/sh.d), d:commonD};
            });
            if(sharers.mother && sharers.mother.type==='1/3 of Residue') {
                let spouseN = assignedShares.husband?.n || assignedShares.wives?.n || 0;
                let motherN = (commonD - spouseN) / 3;
                assignedShares.mother = {n:motherN, d:commonD};
            }
            
            let totalN = Object.values(assignedShares).reduce((sum,s)=>sum+s.n,0);
            let residueN = commonD - totalN;

            if (residueN > 0 && asaba) {
                const maleCount = has(asaba.m) ? h[asaba.m] : 0;
                const femaleCount = asaba.f && has(asaba.f) ? h[asaba.f] : 0;
                const totalParts = (maleCount * asaba.p) + femaleCount;
                if(maleCount>0) { assignedShares[asaba.m] = {n: (assignedShares[asaba.m]?.n || 0) + residueN * (maleCount*asaba.p/totalParts), d:commonD}; explanations[asaba.m] = asaba.r || `Inherits the residue as a primary Residuary ('Asabah).`;}
                if(femaleCount>0) { assignedShares[asaba.f] = {n: (assignedShares[asaba.f]?.n || 0) + residueN * (femaleCount/totalParts), d:commonD}; explanations[asaba.f] = `Inherits as a Residuary with ${heirs[asaba.m].name}.`;}
                totalN = commonD;
            }

            if (totalN > commonD) { // Awl
                specialCase = { name: 'Case of Al-Awl (Abatement)', explanation: 'The sum of the prescribed shares is greater than the total estate. All shares have been proportionally reduced to ensure a just distribution.' };
                commonD = totalN;
            } else if (totalN < commonD) { // Radd
                const raddEligible = Object.keys(assignedShares).filter(id => id !== 'husband' && id !== 'wives');
                if (raddEligible.length > 0 && !asaba) {
                     specialCase = { name: 'Case of Al-Radd (Return)', explanation: 'A surplus exists and there are no Residuaries to take it. The surplus is returned to the eligible Sharers proportionally.' };
                     const raddResidue = commonD - totalN;
                     const raddTotalN = raddEligible.reduce((acc, id) => acc + assignedShares[id].n, 0);
                     if(raddTotalN > 0) raddEligible.forEach(id => {assignedShares[id].n += raddResidue * (assignedShares[id].n / raddTotalN); explanations[id] += ' Share increased due to Radd (Return).'});
                     else if (raddEligible.length > 0) raddEligible.forEach(id => {assignedShares[id].n += raddResidue / raddEligible.length; explanations[id] += ' Share increased due to Radd (Return).'});
                } else if (!asaba && (commonD - Object.values(assignedShares).reduce((sum,s)=>sum+s.n,0)) > 0.001) {
                    assignedShares['bayt_al_mal'] = {n: commonD - totalN, d: commonD, count: 1, name: 'Public Treasury', explanation: 'The surplus of the estate reverts to the public treasury as there are no eligible residuaries or heirs for Radd.'};
                }
            }
            
            let distribution = Object.keys(heirs).map(id => {
                const heirInfo = heirs[id];
                const shareData = assignedShares[id];
                if (shareData && shareData.n > 0) {
                    const percentage = (shareData.n / commonD) * 100;
                    return {name: heirInfo.name, count: heirInfo.count, shareNumerator: shareData.n, shareDenominator: commonD, shareType: 'Calculated', percentage: percentage, amount: s.netEstate * percentage / 100, explanation: explanations[id] || 'Inherits a calculated share.'};
                } else {
                    return {name: heirInfo.name, count: heirInfo.count, shareType: 'Excluded', percentage: 0, amount: 0, explanation: explanations[id] || 'Does not inherit in this scenario.'};
                }
            }).filter(Boolean);

            if(assignedShares['bayt_al_mal']) {
                const f = assignedShares['bayt_al_mal'];
                const percentage = (f.n/commonD)*100;
                distribution.push({name:f.name, count:f.count, shareNumerator: f.n, shareDenominator: commonD, shareType: 'Surplus', percentage, amount: s.netEstate*percentage/100, explanation: f.explanation});
            }

            return { distribution, netEstate: s.netEstate, specialCase };
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            updateProgress();
            document.querySelector('.radio-card input[name="madhhab"]').parentElement.classList.add('selected');
        });
    </script>
</body>
</html>
